# Dagster Cloud Agent Configuration for Azure Container Apps with ACI Code Servers
#
# This configuration enables a fully serverless Dagster deployment on Azure:
# - Agent runs on Azure Container Apps (always-on)
# - Code servers launch on Azure Container Instances (on-demand)
# - All within customer's Azure subscription

# Agent instance configuration
instance_class:
  module: dagster_cloud.instance
  class: DagsterCloudAgentInstance

# User code launcher - Custom ACA implementation
user_code_launcher:
  module: aca_launcher
  class: AcaUserCodeLauncher
  config:
    # Azure subscription where code servers will be created
    # Can be set via environment variable AZURE_SUBSCRIPTION_ID
    subscription_id: ${AZURE_SUBSCRIPTION_ID}

    # Resource group where Container Apps will be created
    # Code servers will be created in the SAME resource group as the agent
    # This allows them to share the same Container Apps Environment
    resource_group: ${AGENT_RESOURCE_GROUP:dagster-aca-rg}

    # Container Apps Environment name (must match the agent's environment)
    environment_name: ${ENVIRONMENT_NAME:dagster-aca-env}

    # Azure region (should match agent region)
    location: ${AZURE_LOCATION:eastus}

    # Default compute resources for code servers
    # Can be overridden per code location via container_context
    cpu: 0.5  # vCPU cores (0.25, 0.5, 1.0, 2.0, etc.)
    memory: 1.0Gi  # Memory (e.g., 0.5Gi, 1.0Gi, 2.0Gi)

# Agent settings
dagster_cloud_api:
  # Agent token (fetched from Key Vault by entrypoint.py)
  agent_token: ${DAGSTER_CLOUD_API_TOKEN}

  # Dagster Cloud URL (constructed from org ID)
  # Format: https://{org}.agent.dagster.cloud
  url: https://${DAGSTER_CLOUD_ORG_ID}.agent.dagster.cloud

  # Deployment name
  deployment: ${DAGSTER_CLOUD_DEPLOYMENT_NAME:prod}

# Logging configuration
python_logs:
  # Log level for agent
  python_log_level: INFO

  # Structured logging for Azure Monitor integration
  managed_python_loggers:
    - dagster_cloud
    - aca_launcher
    - azure.mgmt.appcontainers

# Optional: Run launcher for executing runs
# By default, code servers handle run execution
# Uncomment to use a different run launcher (e.g., ACI jobs for runs)
# run_launcher:
#   module: dagster_cloud.run_launcher
#   class: DefaultRunLauncher
